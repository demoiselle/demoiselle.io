<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Capítulo 3. Funcionalidades relativas ao Keystore</title><link rel="stylesheet" href="css/demoiselleframework.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="Demoiselle Signer"/><link rel="up" href="core-master.html" title="Parte I. Core"/><link rel="prev" href="certificate-funcionalidades.html" title="Capítulo 2. Funcionalidades relativas ao Certificado"/><link rel="next" href="policy-impl-cades-master.html" title="Parte II. Implementação das Políticas CAdES"/><meta xmlns="" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.frameworkdemoiselle.gov.br" class="site_href"><strong>FrameworkDemoiselle.gov.br</strong></a><a href="http://www.frameworkdemoiselle.gov.br" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="certificate-funcionalidades.html"><strong>Anterior</strong></a></li><li class="next"><a accesskey="n" href="policy-impl-cades-master.html"><strong>Próxima</strong></a></li></ul><div class="chapter" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="funcionalidades-keystore"/>Capítulo 3. Funcionalidades relativas ao Keystore</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="funcionalidades-keystore.html#d0e453">3.1. Introdução</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e499">3.2. Carregamento de KeyStore PKCS#12</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e513">3.3. Carregamento de KeyStore PKCS#11 em ambiente Linux</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e540">3.4. Carregamento de KeyStore PKCS#11 em ambiente Windows</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#lista-drivers">3.5. Lista de Drivers</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e720">3.6. Configuração de Token / SmartCard em tempo de execução</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e736">3.7. Configuração de Token / SmartCard por variáveis de ambiente</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e865">3.8. Configuração de Token / SmartCard por arquivo de configurações</a></span></dt><dd><dl><dt><span class="section"><a href="funcionalidades-keystore.html#d0e870">3.8.1. Utilizando certificados armazenados em Disco ou em Token / SmartCard no Windows</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e878">3.8.2. Utilizando certificados armazenados em Disco no Linux ou Mac</a></span></dt><dt><span class="section"><a href="funcionalidades-keystore.html#d0e911">3.8.3. Utilizando certificados armazenados em Token / SmartCard no Linux ou Mac</a></span></dt></dl></dd><dt><span class="section"><a href="funcionalidades-keystore.html#disable_layer_mscapi">3.9. Desabilitar a camada de acesso SunMSCAPI</a></span></dt></dl></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e453"/>3.1. Introdução</h2></div></div></div><p>
            A <a class="ulink" href="www.rsalabs.com/">RSA Laboratories</a>  definiu algumas especificações de uso de criptografia e assinatura digital conhecidas pelo prefixo <a class="ulink" href="https://brazil.emc.com/emc-plus/rsa-labs/standards-initiatives/public-key-cryptography-standards.htm">PKCS</a>. 
            Duas delas estão relacionadas ao tipo de keystore (chaveiro) que é o recipiente que armazena um par de chaves criptográficas. São elas PKCS#11 e PKCS#12.
        </p><p>
            PKCS#11 define uma API genérica para acesso a hardware criptográfico, comumente chamados de Token (pendrive) ou Smartcard (cartão e leitora).
        </p><p>
            PKCS#12 define um formato de arquivo digital usado para guardar chaves privadas acompanhadas de seus certificados digitais.
        </p><p>
            A linguagem Java suporta a utilização desses formatos e com isso define o que chamamos de KeyStore. 
             Um KeyStore é usado para armazenar um ou mais certificados digitais  e também o par de chaves,
             com isso é possível utilizar os padrões da RSA através da mesma interface. 
             A partir de um objeto KeyStore instanciado é possível navegar pelos
            certificados digitais contidos no KeyStore por meio dos apelidos (alias) destes certificados.
        </p><p>
            O componente Demoiselle-Signer visa facilitar o uso destes KeyStores, seja PKCS#11 ou PKCS#12. 
            A maneira como se carrega um KeyStore do tipo PKCS#11, que é um dispositivo em hardware, 
            difere quando trabalhamos com sistemas operacionais diferentes e, em alguns casos,até mesmo versões de JVM.
        </p><p>
            No ambiente Windows, é possível utilizar a API padrão do sistema operacional de carregamento de KeyStore PKCS#11, chamada <a class="ulink" href="https://en.wikipedia.org/wiki/Microsoft_CryptoAPI">MSCAPI</a>  
            que controla os certificados instalados de uma forma mais genérica, mas para isso precisamos também saber a versão da JVM instalada. 
            Isso é necessário porque na versão 1.6 a implementação JCE já comporta o tratamento nativo na
            plataforma e na versão 1.5 ou inferior é necessário utilizar uma biblioteca para trabalhar com a API nativa do Windows.
        </p><p>
            Em ambiente Unix-like é possível carregar um KeyStore PKCS#11 a partir de um driver específico, mas é preciso saber o fabricante e o caminho do driver no sistema
            operacional.
        </p><p>Para carregamento de KeyStore formato PKCS#12, ou seja, em arquivo, o processo de carregamento é o mesmo para os diversos sistemas operacionais.</p></div><p>
        As funcionalidades do componente estão acessíveis por meio da fábrica <span class="emphasis"><em>org.demoiselle.signer.core.keystore.loader.factory.KeyStoreLoaderFactory</em></span>
        de objetos do tipo <span class="emphasis"><em>org.demoiselle.signer.core.keystore.loader.KeyStoreLoader.</em></span>
    </p><p>
        O uso da fábrica é importante, mas não é obrigatório. A importância dela se deve à funcionalidade de descobrir qual a melhor implementação para o carregamento de KeyStore
        baseando-se em configurações. Utilizando a fábrica não é necessário escrever códigos específicos para um determinado sistema operacional, pois a fábrica identifica qual o
        sistema operacional e a versão da JVM para fabricar a melhor implementação.
    </p><p>
        Exemplo de uso da fábrica de objetos KeyStoreLoader
    </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStoreLoader</span><!-- <br/> --><span class="java_plain">&nbsp;keyStoreLoader&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KeyStoreLoaderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">factoryKeyStoreLoader</span><!-- <br/> --><span class="java_separator">();</span></pre><p>
        Exemplo de uso da fábrica de objetos KeyStoreLoader para KeyStore PKCS#12
    </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStoreLoader</span><!-- <br/> --><span class="java_plain">&nbsp;keyStoreLoader&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KeyStoreLoaderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">factoryKeyStoreLoader</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">File</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;/usr/keystore.p12&quot;</span><!-- <br/> --><span class="java_separator">));</span></pre><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e499"/>3.2. Carregamento de KeyStore PKCS#12</h2></div></div></div><p>
            Para carregar um KeyStore a partir de uma arquivo no formato PKCS#12 basta utilizar a classe
            <span class="emphasis"><em>org.demoiselle.signer.core.keystore.loader.implementation.FileSystemKeyStoreLoader.</em></span>
        </p><p>
            Abaixo temos exemplos de uso.
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">FileSystemKeyStoreLoader</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">File</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;/usr/keystore.p12&quot;</span><!-- <br/> --><span class="java_separator">))).</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;password&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KeyStoreLoaderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">factoryKeyStoreLoader</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">File</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;/usr/keystore.p12&quot;</span><!-- <br/> --><span class="java_separator">)).</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;password&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e513"/>3.3. Carregamento de KeyStore PKCS#11 em ambiente Linux</h2></div></div></div><p>
            Para carregar um KeyStore PKCS#11 basta utilizar a classe <span class="emphasis"><em>org.demoiselle.signer.core.keystore.loader.implementation.DriverKeyStoreLoader</em></span>
        </p><p>
            Para configuração de drivers favor acessar a área de Configuração do componente em <a class="xref" href="funcionalidades-keystore.html#lista-drivers" title="3.5. Lista de Drivers">Seção 3.5, “Lista de Drivers”</a>.
        </p><p>
            Abaixo temos exemplos de uso.
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DriverKeyStoreLoader</span><!-- <br/> --><span class="java_separator">()).</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;PIN&nbsp;NUMBER&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KeyStoreLoaderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">factoryKeyStoreLoader</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;PIN&nbsp;NUMBER&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre><p>
            Caso se queira instanciar um KeyStore a partir de um driver específico que não esteja na lista de driver configurada, é possível informar o driver como parâmetro para a classe, veja o exemplo:
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DriverKeyStoreLoader</span><!-- <br/> --><span class="java_separator">()).</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;PIN&nbsp;NUMBER&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Pronova&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;/usr/lib/libepsng_p11.so&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DriverKeyStoreLoader</span><!-- <br/> --><span class="java_separator">()).</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;PIN&nbsp;NUMBER&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;/usr/lib/libepsng_p11.so&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Importante</h2><p>
                Este código também funciona em ambiente Windows, bastando especificar o driver correto a ser utilizado.
            </p></div></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e540"/>3.4. Carregamento de KeyStore PKCS#11 em ambiente Windows</h2></div></div></div><p>
            Para carregar um KeyStore utilizando a API nativa do Windows basta utilizar a classe <span class="emphasis"><em>br.gov.frameworkdemoiselle.certificate.keystore.loader.implementation.MSKeyStoreLoader.</em></span>
        </p><p>
            Abaixo temos exemplos de uso.
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">MSKeyStoreLoader</span><!-- <br/> --><span class="java_separator">()).</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">null</span><!-- <br/> --><span class="java_separator">);</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">KeyStore</span><!-- <br/> --><span class="java_plain">&nbsp;keyStore&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">KeyStoreLoaderFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">factoryKeyStoreLoader</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getKeyStore</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">null</span><!-- <br/> --><span class="java_separator">);</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Importante</h2><p>
                Este recurso só funciona em JVM 1.6 ou superior. Caso deseje executar em um ambiente com o Java mais antigo, desabilite a camada MSCAPI e faça o acesso
                diretamente pelo driver. Para saber como proceder, consulte <a class="xref" href="funcionalidades-keystore.html#disable_layer_mscapi" title="3.9. Desabilitar a camada de acesso SunMSCAPI">Seção 3.9, “Desabilitar a camada de acesso SunMSCAPI”</a>.
            </p></div></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="lista-drivers"/>3.5. Lista de Drivers</h2></div></div></div><p>
            Uma das configurações mais importantes desse componente é a lista de drivers PKCS#11 e seus respectivos arquivos. O componente já possui uma lista pré-estabelecida conforme a
            tabela a seguir.
        </p><div class="table"><a id="d0e564"/><p class="title"><b>Tabela 3.1. Drivers pré definidos para Linux</b></p><div class="table-contents"><table summary="Drivers pré definidos para Linux" width="100%" border="1"><colgroup><col/></colgroup><thead><tr><th>Caminho (Path) do Driver</th></tr></thead><tbody><tr><td>/usr/lib/libaetpkss.so</td></tr><tr><td>/usr/lib/libgpkcs11.so</td></tr><tr><td>/usr/lib/libgpkcs11.so.2</td></tr><tr><td>/usr/lib/libepsng_p11.so</td></tr><tr><td>/usr/lib/libepsng_p11.so.1</td></tr><tr><td>/usr/local/ngsrv/libepsng_p11.so.1</td></tr><tr><td>/usr/lib/libeTPkcs11.so</td></tr><tr><td>/usr/lib/libeToken.so</td></tr><tr><td>/usr/lib/libeToken.so.4</td></tr><tr><td>/usr/lib/libcmP11.so</td></tr><tr><td>/usr/lib/libwdpkcs.so</td></tr><tr><td>/usr/local/lib64/libwdpkcs.so</td></tr><tr><td>/usr/local/lib/libwdpkcs.so</td></tr><tr><td>/usr/lib/watchdata/ICP/lib/libwdpkcs_icp.so</td></tr><tr><td>/usr/lib/watchdata/lib/libwdpkcs.so</td></tr><tr><td>/opt/watchdata/lib64/libwdpkcs.so</td></tr><tr><td>/usr/lib/opensc-pkcs11.so</td></tr><tr><td>/usr/lib/pkcs11/opensc-pkcs11.so</td></tr><tr><td>/usr/local/ngsrv/libepsng_p11.so.1.2.2</td></tr><tr><td>/usr/lib/libneoidp11.so</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e634"/><p class="title"><b>Tabela 3.2. Drivers pré definidos para windows</b></p><div class="table-contents"><table summary="Drivers pré definidos para windows" width="100%" border="1"><colgroup><col/></colgroup><thead><tr><th>Caminho (Path) do Driver</th></tr></thead><tbody><tr><td>WINDOWS_HOME/system32/ngp11v211.dll</td></tr><tr><td>WINDOWS_HOME/system32/aetpkss1.dll</td></tr><tr><td>WINDOWS_HOME/system32/gclib.dll</td></tr><tr><td>WINDOWS_HOME/system32/pk2priv.dll</td></tr><tr><td>WINDOWS_HOME/system32/w32pk2ig.dll</td></tr><tr><td>WINDOWS_HOME/system32/eTPkcs11.dll</td></tr><tr><td>WINDOWS_HOME/system32/acospkcs11.dll</td></tr><tr><td>WINDOWS_HOME/system32/dkck201.dll</td></tr><tr><td>WINDOWS_HOME/system32/dkck232.dll</td></tr><tr><td>WINDOWS_HOME/system32/cryptoki22.dll</td></tr><tr><td>WINDOWS_HOME/system32/acpkcs.dll</td></tr><tr><td>WINDOWS_HOME/system32/slbck.dll</td></tr><tr><td>WINDOWS_HOME/system32/cmP11.dll</td></tr><tr><td>WINDOWS_HOME/system32/WDPKCS.dll</td></tr><tr><td>WINDOWS_HOME/System32/Watchdata/Watchdata Brazil CSP v1.0/WDPKCS.dll</td></tr><tr><td>/Arquivos de programas/Gemplus/GemSafe Libraries/BIN/gclib.dll</td></tr><tr><td>/Program Files/Gemplus/GemSafe Libraries/BIN/gclib.dll</td></tr><tr><td>/system32/SerproPkcs11.dll</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e698"/><p class="title"><b>Tabela 3.3. Drivers pré definidos para Mac</b></p><div class="table-contents"><table summary="Drivers pré definidos para Mac" width="100%" border="1"><colgroup><col/></colgroup><thead><tr><th>Caminho (Path) do Driver</th></tr></thead><tbody><tr><td>/usr/lib/libwdpkcs.dylib</td></tr><tr><td>/usr/local/lib/libwdpkcs.dylib</td></tr><tr><td>/usr/local/lib/libetpkcs11.dylib</td></tr><tr><td>/usr/local/lib/libaetpkss.dylib</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e720"/>3.6. Configuração de Token / SmartCard em tempo de execução</h2></div></div></div><p>
            É possível, porém, adicionar mais drivers em tempo de execução. Para isso é necessário trabalhar com a classe
            <code class="literal">org.demoiselle.signer.core.keystore.loader.configuration.Configuration.</code>
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getInstance</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">addDriver</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;Nome&nbsp;do&nbsp;Driver&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;Path&nbsp;do&nbsp;Driver&quot;</span><!-- <br/> --><span class="java_separator">);</span></pre><p>
            Este código irá procurar pelo driver e caso ele exista, ou seja, o path do arquivo for válido, o driver será colocado a disposição para futuro uso pelas
            implementações de carregamento de KeyStore.
        </p><p>
            Caso seja necessário verificar os drivers já informados, podemos usar a seguinte construção:
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Map</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;drivers&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getInstance</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getDrivers</span><!-- <br/> --><span class="java_separator">();</span></pre></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e736"/>3.7. Configuração de Token / SmartCard por variáveis de ambiente</h2></div></div></div><p>
            Em algumas ocasiões pode ser inviável utilizar o Configuration para adicionar um driver diretamente no código. Neste caso, A API do Java permite definir um arquivo
            de configuração onde pode-se informar o nome do driver e seus parâmetros. O componente permite a definição desse arquivo por meio de váriáveis de
            ambiente ou variáveis da JVM.
        </p><p>
            Abaixo temos o exemplo de como declarar essas configurações.
        </p><div class="table"><a id="d0e743"/><p class="title"><b>Tabela 3.4. Configurações do PKCS#11</b></p><div class="table-contents"><table summary="Configurações do PKCS#11" width="100%" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Ambiente</th><th>Variável de Ambiente</th><th>Variável JVM</th></tr></thead><tbody><tr><td>Linux</td><td>export PKCS11_CONFIG_FILE=/usr/pkcs11/drivers.config</td><td>-DPKCS11_CONFIG_FILE=/usr/pkcs11/drivers.config</td></tr><tr><td>Windows</td><td>set PKCS11_CONFIG_FILE=c:/pkcs11/drivers.config</td><td>-DPKCS11_CONFIG_FILE=c:/pkcs11/drivers.config</td></tr></tbody></table></div></div><br class="table-break"/><p>
            A estrutura deste arquivo pode ser encontrada
            <a class="ulink" href="http://java.sun.com/j2se/1.5.0/docs/guide/security/p11guide.html">aqui</a>
            para Java 1.5,
            <a class="ulink" href="http://java.sun.com/javase/6/docs/technotes/guides/security/p11guide.html">aqui</a>
            para Java 1.6 ou
            <a class="ulink" href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html">aqui</a>
            para Java 1.7.
        </p><p>
            Uma alternativa a este arquivo de configuração é informar o driver diretamente. Para isso basta informar na variável, conforme o exemplo abaixo.
        </p><div class="table"><a id="d0e786"/><p class="title"><b>Tabela 3.5. Configurações do PKCS#11</b></p><div class="table-contents"><table summary="Configurações do PKCS#11" width="100%" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Ambiente</th><th>Variável de Ambiente</th><th>Variável JVM</th></tr></thead><tbody><tr><td>Linux</td><td>export PKCS11_DRIVER=/usr/lib/libepsng_p11.so</td><td>-DPKCS11_DRIVER=/usr/lib/libepsng_p11.so</td></tr><tr><td>Windows</td><td>set PKCS11_DRIVER=/WINDOWS/system32/ngp11v211.dll</td><td>-DPKCS11_DRIVER=/WINDOWS/system32/ngp11v211.dll</td></tr><tr><td>Linux</td><td>export PKCS11_DRIVER=Pronova::/usr/lib/libepsng_p11.so</td><td>-DPKCS11_DRIVER=Pronova::/usr/lib/libepsng_p11.so</td></tr><tr><td>Windows</td><td>set PKCS11_DRIVER=Pronova::/WINDOWS/system32/ngp11v211.dll</td><td>-DPKCS11_DRIVER=Pronova::/WINDOWS/system32/ngp11v211.dll</td></tr></tbody></table></div></div><br class="table-break"/><p>
            Quando a variável for declarada através da JVM, ela deve ser feita diretamente no painel de controle do JAVA. A seguir demonstramos a configuração para o sistema Windows.
        </p><p>
            Abra o painel de controle e seleciona e abra o aplicativo "Java".
        </p><p>
            </p><div class="figure"><a id="d0e836"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/keystore_tela01.png" align="middle" alt="Java no Painel de Controle"/></div></div><p class="title"><b>Figura 3.1. 
                    Java no Painel de Controle
                </b></p></div><p><br class="figure-break"/>
        </p><p>
            Selecione a aba "Java" e clique em "View..."
        </p><p>
            </p><div class="figure"><a id="d0e847"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/keystore_tela02.png" align="middle" alt="Configurações do ambiente Java"/></div></div><p class="title"><b>Figura 3.2. 
                    Configurações do ambiente Java
                </b></p></div><p><br class="figure-break"/>
        </p><p>
            Na aba "User", em "Runtime Parameters", coloque a declaração da variável. Em seguida, aplique as alterações.
        </p><p>
            </p><div class="figure"><a id="d0e858"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/keystore_tela03.png" align="middle" alt="Desabilitando a camada MSCAPI"/></div></div><p class="title"><b>Figura 3.3. 
                    Desabilitando a camada MSCAPI
                </b></p></div><p><br class="figure-break"/>
        </p></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="d0e865"/>3.8. Configuração de Token / SmartCard por arquivo de configurações</h2></div></div></div><p>
            As configurações acima demonstram uma configuração mais refinada para o carregamento de certificados em dispositivos, mas o componente possui um procedimento
            padrão a ser executado caso se deseje um método mais simplificado. A seguir é explicado como utilizar este mecanismo.
        </p><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h3 class="title"><a id="d0e870"/>3.8.1. Utilizando certificados armazenados em Disco ou em Token / SmartCard no Windows</h3></div></div></div><p>
                O Sistema Operacional Windows fornece uma camada chamada MSCAPI, ou Microsoft CryptoAPI, que facilita o acesso a certificados armazenados em disco ou em dispositivos
                criptográficos. Neste tipo de acesso, basta que o certificado esteja corretamente instalado e válido, e a própria camada nos fornecerá o driver correto e os meios para
                acessar os certificados. Até a versão 5 do Java não existia um provedor de acesso para esta camada, mas na versão 6 em diante foi implementado
                o provedor <span class="emphasis"><em>SunMSCAPI</em></span> para lidar com este tipo de acesso.
            </p></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h3 class="title"><a id="d0e878"/>3.8.2. Utilizando certificados armazenados em Disco no Linux ou Mac</h3></div></div></div><p>
                Ao Contrario do Windows, que utiliza a API da <a class="ulink" href="http://en.wikipedia.org/wiki/Microsoft_CryptoAPI">MS-CAPI</a>
                para abstrair o acesso aos certificados digitais, em outros sistemas operacionais este recurso não existe. Para efetuar o acesso, precisamos criar um arquivo
                de configuração informando os parâmetros de acesso.
            </p><p>
                Para viabilizar o acesso em um sistema Não-Windows, deve ser criado um arquivo chamado <code class="filename">drivers.config</code> dentro do diretório
                [<span class="citation">/home/usuario</span>] com a parametrização mostrada abaixo. Nesta configuração serão carregados todos os certificados A1 que estejam
                instalados no Firefox.
            </p><p>
                Para o Ubuntu:
            </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XHTML"><!-- XHTML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_plain">name&nbsp;=&nbsp;Provedor</span><br />
<span class="xml_plain">slot&nbsp;=&nbsp;2</span><br />
<span class="xml_plain">#&nbsp;para&nbsp;64&nbsp;bits</span><br />
<span class="xml_plain">library&nbsp;=&nbsp;/usr/lib/x86_64-linux-gnu/nss/libsoftokn3.so</span><br />
<span class="xml_plain">#&nbsp;para&nbsp;32&nbsp;bits</span><br />
<span class="xml_plain">#&nbsp;library&nbsp;=&nbsp;/usr/lib/nss/libsoftokn3.so</span><br />
<span class="xml_plain">nssArgs&nbsp;=&nbsp;&quot;configdir='/home/</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">usuario</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">/.mozilla/firefox/</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">nnnnnnnn</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">.default'&nbsp;certPrefix=''&nbsp;keyPrefix=''&nbsp;secmod='secmod.db'&nbsp;&nbsp;flags='readWrite'&quot;</span><br />
<span class="xml_plain">showInfo=true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
</pre><p>
                Para o Mac OS:
            </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XHTML"><!-- XHTML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_plain">name&nbsp;=&nbsp;Provedor</span><br />
<span class="xml_plain">slot&nbsp;=&nbsp;2</span><br />
<span class="xml_plain">library&nbsp;=&nbsp;/Applications/Firefox.app/Contents/MacOS/libsoftokn3.dylib</span><br />
<span class="xml_plain">nssArgs&nbsp;=&nbsp;&quot;configdir='/Users/</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">usuario</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">/Library/Application&nbsp;Support/Firefox/Profiles/</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">nnnnnnnnn</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">.default'&nbsp;certPrefix=''&nbsp;keyPrefix=''&nbsp;secmod='secmod.db'&nbsp;flags='readOnly'&quot;</span><br />
</pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Importante</h2><p>
                    A sequência de caracteres que precede o
                    <span class="emphasis"><em>.default</em></span>
                    , como em
                    <span class="emphasis"><em>nnnnnnnn.default</em></span>
                    é criptografada e, sendo assim, é diferente para cada equipamento e cada usuário.
                </p></div></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h3 class="title"><a id="d0e911"/>3.8.3. Utilizando certificados armazenados em Token / SmartCard no Linux ou Mac</h3></div></div></div><p>
                Para configurar um token A3, o conteúdo do arquivo
                <code class="filename">drivers.config</code>
                deve ser especificado como mostrado abaixo.
            </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Provedor</span>
<!--  --><br/><span class="java_plain">description&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Token</span><span class="java_plain">&nbsp;</span><span class="java_type">Pronova</span><span class="java_plain">&nbsp;ePass2000</span>
<!--  --><br/><span class="java_plain">library&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">usr</span><span class="java_operator">/</span><span class="java_plain">local</span><span class="java_operator">/</span><span class="java_plain">ngsrv</span><span class="java_operator">/</span><span class="java_plain">libepsng_p11</span><span class="java_separator">.</span><span class="java_plain">so</span><span class="java_literal">.1.2.2</span>
</pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Importante</h2><p>
                    Não é possível utilizar certificados A3 e A1 no Linux ou Mac simultaneamente, devendo ser configurado somente UM dos tipos de acesso em um determinado momento.
                </p></div></div></div><div class="section" lang="pt-BR"><div class="titlepage"><div><div><h2 class="title"><a id="disable_layer_mscapi"/>3.9. Desabilitar a camada de acesso SunMSCAPI</h2></div></div></div><p>
            Quando o componente é utilizado em ambiente Windows, o acesso é feito através de uma camada de abstração chamada MSCAPI, que abstrai informações que são particulares
            de cada token ou smartcard, como os drivers do dispositivo, por exemplo. Este tipo de recurso facilita o uso do componente com dispositivos de diversos
            fabricantes.
            Porém, podem existir casos específicos em que o acesso precisa ser feito diretamente ao driver para utilização de funções específicas, como forçar o logout de um token.
            Para isso, é necessário informar na JVM um parâmetro chamado
            <code class="literal">mscapi.disabled</code>
            passando o valor
            <code class="literal">true</code>
            . Este parâmetro informa que
            o acesso será feito via PKCS11, sendo necessário informar o arquivo de configuração do token que se deseja acessar. Caso o parâmetro
            <code class="literal">mscapi.disabled</code>
            esteja ausente, o componente fará uso do MSCAPI normalmente.
        </p><p>
            A seguir demonstramos a configuração para o sistema Windows.
        </p><p>
            </p><div class="figure"><a id="d0e942"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/keystore_tela04.png" align="middle" alt="Desabilitando a camada MSCAPI"/></div></div><p class="title"><b>Figura 3.4. 
                    Desabilitando a camada MSCAPI
                </b></p></div><p><br class="figure-break"/>
        </p></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="certificate-funcionalidades.html"><strong>Anterior</strong>Capítulo 2. Funcionalidades relativas ao Certific...</a></li><li class="up"><a accesskey="u" href="#"><strong>Acima</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Principal</strong></a></li><li class="next"><a accesskey="n" href="policy-impl-cades-master.html"><strong>Próxima</strong>Parte II. Implementação das Políticas CAdES</a></li></ul></body></html>